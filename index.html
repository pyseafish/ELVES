<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELVES - ä¸šä½™æ— çº¿ç”µé€šè”è®°å½•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cbc;
            --background-color: #f5f7fa;
            --surface-color: #ffffff;
            --text-color: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        .dark-mode {
            --primary-color: #5b8cff;
            --secondary-color: #7aa3ff;
            --background-color: #0a0a0a;
            --surface-color: rgba(255, 255, 255, 0.05);
            --text-color: rgba(255, 255, 255, 0.95);
            --text-secondary: rgba(255, 255, 255, 0.7);
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        /* æ¶²æ€ç»ç’ƒæ•ˆæœ */
        .dark-mode .header {
            background: linear-gradient(135deg, 
                rgba(91, 140, 255, 0.2), 
                rgba(122, 163, 255, 0.15));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* æ·±è‰²æ¨¡å¼ä½¿ç”¨ä¸æµ…è‰²æ¨¡å¼ç›¸åŒçš„é€»è¾‘ */
        .dark-mode .filter-section,
        .dark-mode .form-section,
        .dark-mode .modal-content,
        .dark-mode .message-content {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }
        
        .dark-mode .record-card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }
        
        .dark-mode .select-header {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
        }
        
        .dark-mode .select-options {
            background: rgba(30, 30, 30, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 1000; /* ç¡®ä¿æ˜¾ç¤ºåœ¨æœ€ä¸Šå±‚ */
        }
        
        .dark-mode .bottom-nav {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .dark-mode .nav-item.active {
            background: rgba(91, 140, 255, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .dark-mode .select-option:hover {
            background: rgba(91, 140, 255, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            transition: all 0.3s ease;
            min-height: 100vh;
            padding-bottom: 70px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .header:hover {
            box-shadow: 0 4px 30px rgba(0,0,0,0.2);
            transform: translateY(-1px);
        }

        .header-title {
            font-size: 18px;
            font-weight: 600;
        }

        .header-time {
            font-size: 14px;
            font-family: 'Courier New', monospace;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .timezone {
            font-size: 12px;
            opacity: 0.8;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .dark-mode .timezone {
            background: rgba(255, 255, 255, 0.05);
        }

        .page {
            display: none;
            padding: 20px;
            max-width: 800px;
            min-width: 320px; /* ç¡®ä¿ç§»åŠ¨ç«¯æœ‰ç»Ÿä¸€çš„æœ€å°å®½åº¦ */
            margin: 0 auto;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-sizing: border-box; /* åŒ…å«å†…è¾¹è· */
        }

        .page.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .filter-section {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .filter-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .filter-content.collapsed {
            display: none;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-group label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        input, select, textarea {
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--surface-color);
            color: var(--text-color);
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.15), 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
            background: var(--surface-color);
        }

        /* æ—¥æœŸå’Œæ—¶é—´è¾“å…¥æ¡†ç°ä»£æ ·å¼ */
        input[type="date"],
        input[type="time"] {
            background: linear-gradient(135deg, var(--surface-color), rgba(255, 255, 255, 0.05));
            border: 2px solid var(--border-color);
            padding: 12px 15px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        input[type="date"]:hover,
        input[type="time"]:hover {
            border-color: var(--primary-color);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        input[type="date"]:focus,
        input[type="time"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.2), 0 8px 25px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
            background: linear-gradient(135deg, var(--surface-color), rgba(255, 255, 255, 0.1));
        }

        /* æ—¥æœŸå’Œæ—¶é—´é€‰æ‹©å™¨å›¾æ ‡æ ·å¼ */
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            background-size: 18px;
            background-position: center;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            filter: brightness(0.8);
        }

        input[type="date"]::-webkit-calendar-picker-indicator:hover,
        input[type="time"]::-webkit-calendar-picker-indicator:hover {
            background-color: rgba(74, 144, 226, 0.1);
            filter: brightness(1);
        }
        
        /* æ—¥æœŸå’Œæ—¶é—´è¾“å…¥æ¡†æ·±è‰²æ¨¡å¼é€‚é… */
        .dark-mode input[type="date"],
        .dark-mode input[type="time"] {
            background: linear-gradient(135deg, rgba(30, 30, 30, 0.95), rgba(255, 255, 255, 0.05));
            border: 2px solid rgba(255, 255, 255, 0.15);
            color: var(--text-color);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .dark-mode input[type="date"]:hover,
        .dark-mode input[type="time"]:hover {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, rgba(40, 40, 40, 0.95), rgba(255, 255, 255, 0.08));
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
        }
        
        .dark-mode input[type="date"]:focus,
        .dark-mode input[type="time"]:focus {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, rgba(45, 45, 45, 0.95), rgba(255, 255, 255, 0.1));
            box-shadow: 0 0 0 4px rgba(91, 140, 255, 0.3), 0 8px 30px rgba(0, 0, 0, 0.5);
        }
        
        /* æ—¥æœŸå’Œæ—¶é—´é€‰æ‹©å™¨ä¸‹æ‹‰æ¡†æ·±è‰²æ¨¡å¼æ ·å¼ */
        .dark-mode input[type="date"]::-webkit-calendar-picker-indicator,
        .dark-mode input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(0.9) brightness(1.2);
        }

        .dark-mode input[type="date"]::-webkit-calendar-picker-indicator:hover,
        .dark-mode input[type="time"]::-webkit-calendar-picker-indicator:hover {
            background-color: rgba(91, 140, 255, 0.2);
            filter: invert(1) brightness(1.5);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: var(--surface-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }

        .record-card {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            margin: 10px 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            z-index: 1; /* ç¡®ä¿è®°å½•å¡ç‰‡ä¸ä¼šé®æŒ¡ä¸‹æ‹‰æ¡† */
            position: relative;
        }
        
        .record-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: var(--primary-color);
        }

        .record-summary {
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .record-callsign {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .contest-badge {
            background: var(--warning-color);
            color: #000;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 8px;
        }

        .record-info {
            text-align: right;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .record-details {
            padding: 0 15px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .record-card.expanded .record-details {
            max-height: 500px;
            padding: 15px;
            border-top: 1px solid var(--border-color);
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .detail-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .detail-value {
            color: var(--text-color);
        }

        .record-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .form-section {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface-color);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 5px 15px;
            cursor: pointer;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            text-align: center;
        }

        .nav-item.active {
            background: var(--primary-color);
            color: white;
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 2px;
        }

        .nav-text {
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 20px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .custom-select {
            position: relative;
        }

        .select-header {
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: var(--surface-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            font-size: 14px;
            min-height: 44px;
        }

        .select-header:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }

        .select-options {
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            right: 0;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            z-index: 1000; /* æé«˜z-indexç¡®ä¿æ˜¾ç¤ºåœ¨æœ€ä¸Šå±‚ */
            max-height: 200px;
            overflow-y: auto;
            overflow-x: hidden; /* é˜²æ­¢æ¨ªå‘æ»šåŠ¨æ¡ */
            display: none;
            animation: fadeIn 0.2s ease;
            width: 100%; /* ç¡®ä¿å®½åº¦ä¸çˆ¶å…ƒç´ ä¸€è‡´ */
            box-sizing: border-box; /* åŒ…å«è¾¹æ¡†å’Œå†…è¾¹è· */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .select-options.active {
            display: block;
        }

        .select-option {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s ease;
            font-size: 14px;
            border-radius: 0;
        }

        .select-option:hover {
            background: var(--primary-color);
            color: white;
            transform: translateX(2px);
        }

        .select-option:first-child {
            border-top-left-radius: 11px;
            border-top-right-radius: 11px;
        }

        .select-option:last-child {
            border-bottom: none;
            border-bottom-left-radius: 11px;
            border-bottom-right-radius: 11px;
        }

        .contest-fields {
            display: none;
        }

        .contest-fields.active {
            display: block;
        }

        /* æ¶ˆæ¯æ¡†æ ·å¼ */
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: none;
            animation: slideInRight 0.3s ease;
        }

        .message-content {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            max-width: 400px;
            box-sizing: border-box; /* åŒ…å«å†…è¾¹è· */
        }

        .message-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .message-text {
            flex: 1;
            font-size: 14px;
            color: var(--text-color);
            line-height: 1.4;
        }

        .message-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        .message-close:hover {
            background-color: var(--border-color);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-content {
                grid-template-columns: 1fr;
            }
            
            .record-summary {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .record-info {
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="header">
        <div class="header-title">ELVES</div>
        <div class="header-callsign" id="headerCallsign"></div>
        <div class="header-time">
            <span id="currentTime"></span>
            <span class="timezone" id="currentTimezone"></span>
        </div>
    </div>

    <!-- è®°å½•é¡µé¢ -->
    <div id="recordsPage" class="page active">
        <!-- ç­›é€‰åŒºåŸŸ -->
        <div class="filter-section">
            <div class="filter-header" onclick="toggleFilter()">
                <span>ç­›é€‰è®°å½•</span>
                <span id="filterToggle">â–¼</span>
            </div>
            <div class="filter-content" id="filterContent">
                <div class="input-group">
                    <label>å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" id="filterDateFrom">
                </div>
                <div class="input-group">
                    <label>ç»“æŸæ—¥æœŸ</label>
                    <input type="date" id="filterDateTo">
                </div>
                <div class="input-group">
                    <label>å‘¼å·</label>
                    <input type="text" id="filterCallsign" placeholder="è¾“å…¥å‘¼å·">
                </div>
                <div class="input-group">
                    <label>ç½‘æ ¼</label>
                    <input type="text" id="filterGrid" placeholder="è¾“å…¥ç½‘æ ¼">
                </div>
                <div class="input-group">
                    <label>æ¯”èµ›ç±»å‹</label>
                    <div class="custom-select" id="filterContestSelect">
                        <div class="select-header">
                            <span data-value="">å…¨éƒ¨</span>
                            <span>â–¼</span>
                        </div>
                        <div class="select-options">
                            <div class="select-option" data-value="">å…¨éƒ¨</div>
                            <div class="select-option" data-value="CQ WPX">CQ WPX</div>
                            <div class="select-option" data-value="CQWW">CQWW</div>
                            <div class="select-option" data-value="WAPC">WAPC</div>
                        </div>
                    </div>
                </div>
                <div class="input-group">
                    <button class="btn btn-primary" onclick="applyFilters()">åº”ç”¨ç­›é€‰</button>
                    <button class="btn btn-secondary" onclick="clearFilters()">æ¸…é™¤ç­›é€‰</button>
                </div>
            </div>
        </div>

        <!-- è®°å½•åˆ—è¡¨ -->
        <div id="recordsContainer"></div>
    </div>

    <!-- æ–°å¢è®°å½•é¡µé¢ -->
    <div id="addPage" class="page">
        <div class="form-section">
            <h3>æ–°å¢é€šè”è®°å½•</h3>
            <div class="form-grid">
                <div class="input-group">
                    <label>å¯¹æ–¹å‘¼å· *</label>
                    <input type="text" id="callsign" required>
                </div>
                <div class="input-group">
                    <label>é¢‘ç‡ (MHz) *</label>
                    <input type="text" id="frequency" required>
                </div>
                <div class="input-group">
                    <label>æ¨¡å¼ *</label>
                    <div class="custom-select" id="modeSelect">
                        <div class="select-header">
                            <span data-value="SSB">SSB</span>
                            <span>â–¼</span>
                        </div>
                        <div class="select-options">
                            <div class="select-option" data-value="SSB">SSB</div>
                            <div class="select-option" data-value="CW">CW</div>
                            <div class="select-option" data-value="FT8">FT8</div>
                            <div class="select-option" data-value="RTTY">RTTY</div>
                            <div class="select-option" data-value="SSTV">SSTV</div>
                            <div class="select-option" data-value="FM">FM</div>
                            <div class="select-option" data-value="AM">AM</div>
                        </div>
                    </div>
                </div>
                <div class="input-group">
                    <label>æ—¥æœŸ *</label>
                    <input type="date" id="dateInput" required>
                </div>
                <div class="input-group">
                    <label>æ—¶é—´ *</label>
                    <input type="time" id="timeInput" required>
                </div>
                <div class="input-group">
                    <label>RST å‘é€</label>
                    <input type="text" id="rstSent" placeholder="59">
                </div>
                <div class="input-group">
                    <label>RST æ¥æ”¶</label>
                    <input type="text" id="rstRcvd" placeholder="59">
                </div>
                <div class="input-group">
                    <label>å§“å</label>
                    <input type="text" id="name">
                </div>
                <div class="input-group">
                    <label>QTH</label>
                    <input type="text" id="qth">
                </div>
                <div class="input-group">
                    <label>ç½‘æ ¼</label>
                    <input type="text" id="gridsquare" placeholder="ä¾‹å¦‚ï¼šPM95ab">
                </div>
                <div class="input-group">
                    <label>å¯¹æ–¹è®¾å¤‡</label>
                    <input type="text" id="theirEquipment">
                </div>
                <div class="input-group">
                    <label>å¯¹æ–¹å¤©çº¿</label>
                    <input type="text" id="theirAntenna">
                </div>
                <div class="input-group">
                    <label>å¤‡æ³¨</label>
                    <textarea id="comment" rows="2"></textarea>
                </div>
                <div class="input-group">
                    <label>æ¯”èµ›ç±»å‹</label>
                    <div class="custom-select" id="contestSelect">
                        <div class="select-header">
                            <span data-value="">æ— </span>
                            <span>â–¼</span>
                        </div>
                        <div class="select-options">
                            <div class="select-option" data-value="">æ— </div>
                            <div class="select-option" data-value="CQ WPX">CQ WPX</div>
                            <div class="select-option" data-value="CQWW">CQWW</div>
                            <div class="select-option" data-value="WAPC">WAPC</div>
                        </div>
                    </div>
                </div>
                <div class="contest-fields" id="contestFields">
                    <div class="input-group" id="serialField">
                        <label>åºåˆ—å· (CQ WPX)</label>
                        <input type="text" id="serial">
                    </div>
                    <div class="input-group" id="cqzoneField">
                        <label>CQåˆ†åŒº (CQWW)</label>
                        <input type="text" id="cqzone">
                    </div>
                    <div class="input-group" id="qsosNumberField">
                        <label>QSOåºå· (WAPC)</label>
                        <input type="text" id="qsosNumber">
                    </div>
                    <div class="input-group" id="provinceField">
                        <label>çœå¸‚åŒºç¼©å†™ (WAPC)</label>
                        <input type="text" id="province">
                    </div>
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="saveRecord()">ä¿å­˜è®°å½•</button>
                <button class="btn btn-secondary" onclick="clearForm()">æ¸…ç©ºè¡¨å•</button>
                <button class="btn btn-secondary" onclick="importFile()">å¯¼å…¥æ–‡ä»¶</button>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®é¡µé¢ -->
    <div id="settingsPage" class="page">
        <div class="form-section">
            <h3>è®¾ç½®</h3>
            <div class="form-grid">
                <div class="input-group">
                    <label>æˆ‘çš„å‘¼å· *</label>
                    <input type="text" id="myCallsign" required>
                </div>
                <div class="input-group">
                    <label>æˆ‘çš„GRIDç½‘æ ¼</label>
                    <input type="text" id="myGrid">
                </div>
                <div class="input-group">
                    <label>æˆ‘çš„CQåˆ†åŒº</label>
                    <input type="text" id="myCQZone">
                </div>
                <div class="input-group">
                    <label>æˆ‘çš„ITUåˆ†åŒº</label>
                    <input type="text" id="myITUZone">
                </div>
                <div class="input-group">
                    <label>ä½¿ç”¨è®¾å¤‡</label>
                    <input type="text" id="myEquipment">
                </div>
                <div class="input-group">
                    <label>ä½¿ç”¨å¤©çº¿</label>
                    <input type="text" id="myAntenna">
                </div>
                <div class="input-group">
                    <label>æ—¶åŒºæ˜¾ç¤º</label>
                    <div class="custom-select" id="timezoneSelect">
                        <div class="select-header">
                            <span data-value="BJT">BJT</span>
                            <span>â–¼</span>
                        </div>
                        <div class="select-options">
                            <div class="select-option" data-value="UTC">UTC</div>
                            <div class="select-option" data-value="BJT">BJT</div>
                        </div>
                    </div>
                </div>
                <div class="input-group">
                    <label>ç•Œé¢è¯­è¨€</label>
                    <div class="custom-select" id="languageSelect">
                        <div class="select-header">
                            <span data-value="zh-CN">ç®€ä½“ä¸­æ–‡</span>
                            <span>â–¼</span>
                        </div>
                        <div class="select-options">
                            <div class="select-option" data-value="zh-CN">ç®€ä½“ä¸­æ–‡</div>
                            <div class="select-option" data-value="zh-TW">ç¹é«”ä¸­æ–‡</div>
                            <div class="select-option" data-value="en">English</div>
                            <div class="select-option" data-value="ja">æ—¥æœ¬èª</div>
                        </div>
                    </div>
                </div>
                <div class="input-group">
                    <label>ä¸»é¢˜æ¨¡å¼</label>
                    <div class="custom-select" id="themeSelect">
                        <div class="select-header">
                            <span data-value="light">æµ…è‰²æ¨¡å¼</span>
                            <span>â–¼</span>
                        </div>
                        <div class="select-options">
                            <div class="select-option" data-value="light">æµ…è‰²æ¨¡å¼</div>
                            <div class="select-option" data-value="dark">æ·±è‰²æ¨¡å¼</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
                <button class="btn btn-secondary" onclick="showAbout()">å…³äº</button>
            </div>
        </div>
    </div>

    <!-- å¯¼å‡ºé¡µé¢ -->
    <div id="exportPage" class="page">
        <div class="form-section">
            <h3>å¯¼å‡ºè®°å½•</h3>
            <div class="form-grid">
                <div class="input-group">
                    <label>å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" id="exportDateFrom">
                </div>
                <div class="input-group">
                    <label>ç»“æŸæ—¥æœŸ</label>
                    <input type="date" id="exportDateTo">
                </div>
                <div class="input-group">
                    <label>æ¯”èµ›ç±»å‹</label>
                    <div class="custom-select" id="exportContestSelect">
                        <div class="select-header">
                            <span data-value="">å…¨éƒ¨è®°å½•</span>
                            <span>â–¼</span>
                        </div>
                        <div class="select-options">
                            <div class="select-option" data-value="">å…¨éƒ¨è®°å½•</div>
                            <div class="select-option" data-value="CQ WPX">CQ WPX</div>
                            <div class="select-option" data-value="CQWW">CQWW</div>
                            <div class="select-option" data-value="WAPC">WAPC</div>
                        </div>
                    </div>
                </div>
                <div class="input-group">
                    <label>æ–‡ä»¶æ ¼å¼</label>
                    <div class="custom-select" id="exportFormatSelect">
                        <div class="select-header">
                            <span data-value="adi">ADI (.adi)</span>
                            <span>â–¼</span>
                        </div>
                        <div class="select-options">
                            <div class="select-option selected" data-value="adi">ADI (.adi)</div>
                            <div class="select-option" data-value="cabrillo">Cabrillo (.log)</div>
                        </div>
                    </div>
                </div>
                <div class="input-group">
                    <label>æ–‡ä»¶å</label>
                    <input type="text" id="exportFilename" placeholder="ä¾‹å¦‚ï¼šmy_log">
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="exportRecords()">å¯¼å‡ºè®°å½•</button>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('recordsPage')">
            <div class="nav-icon">ğŸ“</div>
            <div class="nav-text">è®°å½•</div>
        </div>
        <div class="nav-item" onclick="switchPage('addPage')">
            <div class="nav-icon">â•</div>
            <div class="nav-text">æ–°å¢</div>
        </div>
        <div class="nav-item" onclick="switchPage('settingsPage')">
            <div class="nav-icon">âš™ï¸</div>
            <div class="nav-text">è®¾ç½®</div>
        </div>
        <div class="nav-item" onclick="switchPage('exportPage')">
            <div class="nav-icon">ğŸ“¤</div>
            <div class="nav-text">å¯¼å‡º</div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div class="modal" id="confirmationModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ç¡®è®¤æ“ä½œ</div>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body" id="modalMessage"></div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="modalConfirm">ç¡®è®¤</button>
                <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div class="modal" id="aboutModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">å…³äº</div>
                <button class="modal-close" onclick="closeAbout()">Ã—</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">ELVES</div>
                    <div style="color: var(--text-secondary); margin-bottom: 10px;">Â© 2025ä¸¨pyseafish (BG5DHV)</div>
                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 15px;">v1.10.2.20251019</div>
                    <div style="font-size: 14px;">
                        <a href="https://github.com/pyseafish/ELVES" target="_blank" style="color: var(--primary-color); text-decoration: none; border-bottom: 1px solid var(--primary-color); padding-bottom: 1px;">
                            <span data-translation="openSourceLink">åŸºäºMITåè®®å¼€æº</span>
                        </a>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeAbout()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="fileInput" accept=".adi,.log,.txt" style="display: none;">

    <!-- æ¶ˆæ¯æ¡† -->
    <div id="messageBox" class="message-box">
        <div class="message-content">
            <div class="message-icon">â„¹ï¸</div>
            <div class="message-text" id="messageText"></div>
            <button class="message-close" onclick="hideMessage()">Ã—</button>
        </div>
    </div>

    <script>
        // åº”ç”¨çŠ¶æ€ç®¡ç†
        const AppState = {
            records: [],
            currentEditingRecord: null,
            settings: {
                myCallsign: '',
                myGrid: '',
                myCQZone: '',
                myITUZone: '',
                myEquipment: '',
                myAntenna: '',
                timezone: 'BJT',
                language: 'zh-CN',
                theme: 'light'
            },
            filters: {
                dateFrom: null,
                dateTo: null,
                callsign: '',
                grid: '',
                contest: ''
            },
            modalCallback: null
        };

        // å¤šè¯­è¨€æ”¯æŒ
        const translations = {
            'zh-CN': {
                'noRecords': 'æš‚æ— è®°å½•',
                'addRecordHint': 'ç‚¹å‡»åº•éƒ¨"æ–°å¢"æŒ‰é’®æ·»åŠ ç¬¬ä¸€æ¡è®°å½•',
                'deleteConfirm': 'ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ',
                'editConfirm': 'ç¡®å®šè¦ä¿®æ”¹è¿™æ¡è®°å½•å—ï¼Ÿ',
                'importConfirm': 'ç¡®å®šè¦å¯¼å…¥è¿™äº›è®°å½•å—ï¼Ÿ',
                'duplicateConfirm': 'å‘ç°é‡å¤è®°å½•ï¼Œæ˜¯å¦ç»§ç»­æ·»åŠ ï¼Ÿ',
                'importPartial': 'éƒ¨åˆ†è®°å½•é‡å¤ï¼Œæ˜¯å¦åªå¯¼å…¥ä¸é‡å¤çš„è®°å½•ï¼Ÿ',
                'openSourceLink': 'åŸºäºMITåè®®å¼€æº'
            },
            'zh-TW': {
                'noRecords': 'æš«ç„¡è¨˜éŒ„',
                'addRecordHint': 'é»æ“Šåº•éƒ¨"æ–°å¢"æŒ‰éˆ•æ·»åŠ ç¬¬ä¸€æ¢è¨˜éŒ„',
                'deleteConfirm': 'ç¢ºå®šè¦åˆªé™¤é€™æ¢è¨˜éŒ„å—ï¼Ÿ',
                'editConfirm': 'ç¢ºå®šè¦ä¿®æ”¹é€™æ¢è¨˜éŒ„å—ï¼Ÿ',
                'importConfirm': 'ç¢ºå®šè¦å°å…¥é€™äº›è¨˜éŒ„å—ï¼Ÿ',
                'duplicateConfirm': 'ç™¼ç¾é‡è¤‡è¨˜éŒ„ï¼Œæ˜¯å¦ç¹¼çºŒæ·»åŠ ï¼Ÿ',
                'importPartial': 'éƒ¨åˆ†è¨˜éŒ„é‡è¤‡ï¼Œæ˜¯å¦åªå°å…¥ä¸é‡è¤‡çš„è¨˜éŒ„ï¼Ÿ',
                'openSourceLink': 'åŸºæ–¼MITå”è­°é–‹æº'
            },
            'en': {
                'noRecords': 'No records yet',
                'addRecordHint': 'Click the "Add" button at the bottom to add your first record',
                'deleteConfirm': 'Are you sure you want to delete this record?',
                'editConfirm': 'Are you sure you want to edit this record?',
                'importConfirm': 'Are you sure you want to import these records?',
                'duplicateConfirm': 'Duplicate records found, continue adding?',
                'importPartial': 'Some records are duplicates, import only unique records?',
                'openSourceLink': 'Open Source under MIT License'
            },
            'ja': {
                'noRecords': 'è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“',
                'addRecordHint': 'ä¸‹éƒ¨ã®ã€Œè¿½åŠ ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æœ€åˆã®è¨˜éŒ²ã‚’è¿½åŠ ã—ã¦ãã ã•ã„',
                'deleteConfirm': 'ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ',
                'editConfirm': 'ã“ã®è¨˜éŒ²ã‚’ç·¨é›†ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ',
                'importConfirm': 'ã“ã‚Œã‚‰ã®è¨˜éŒ²ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ',
                'duplicateConfirm': 'é‡è¤‡ã™ã‚‹è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚è¿½åŠ ã‚’ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ',
                'importPartial': 'ä¸€éƒ¨ã®è¨˜éŒ²ãŒé‡è¤‡ã—ã¦ã„ã¾ã™ã€‚é‡è¤‡ã—ãªã„è¨˜éŒ²ã®ã¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ',
                'openSourceLink': 'MITãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã§ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹'
            }
        };

        // è·å–ç¿»è¯‘
        function getTranslation(key) {
            return translations[AppState.settings.language]?.[key] || key;
        }

        // æ˜¾ç¤ºæ¶ˆæ¯æ¡†
        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const messageIcon = messageBox.querySelector('.message-icon');
            
            // è®¾ç½®æ¶ˆæ¯å†…å®¹
            messageText.textContent = message;
            
            // è®¾ç½®å›¾æ ‡å’Œæ ·å¼
            let icon = 'â„¹ï¸';
            let borderColor = 'var(--border-color)';
            
            switch (type) {
                case 'success':
                    icon = 'âœ…';
                    borderColor = 'var(--success-color)';
                    break;
                case 'warning':
                    icon = 'âš ï¸';
                    borderColor = 'var(--warning-color)';
                    break;
                case 'error':
                    icon = 'âŒ';
                    borderColor = 'var(--error-color)';
                    break;
                default:
                    icon = 'â„¹ï¸';
                    borderColor = 'var(--border-color)';
            }
            
            messageIcon.textContent = icon;
            messageBox.querySelector('.message-content').style.borderColor = borderColor;
            
            // æ˜¾ç¤ºæ¶ˆæ¯æ¡†
            messageBox.style.display = 'block';
            
            // 5ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                hideMessage();
            }, 5000);
        }

        // éšè—æ¶ˆæ¯æ¡†
        function hideMessage() {
            const messageBox = document.getElementById('messageBox');
            messageBox.style.display = 'none';
        }

        // DOMåŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            initPages();
            initUI();
            loadSettings();
            loadRecords();
            renderRecords();
            updateTime();
            setInterval(updateTime, 1000);
            
            // åˆå§‹åŒ–è‡ªå®šä¹‰é€‰æ‹©å™¨
            initCustomSelectors();
            
            // åˆå§‹åŒ–æ¯”èµ›å­—æ®µæ˜¾ç¤º
            updateContestFields();
        });

        // åˆå§‹åŒ–é¡µé¢
        function initPages() {
            // é»˜è®¤æ˜¾ç¤ºè®°å½•é¡µé¢
            switchPage('recordsPage');
            
            // è®¾ç½®åº•éƒ¨å¯¼èˆªäº‹ä»¶
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    navItems.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        // é¡µé¢åˆ‡æ¢
        function switchPage(pageId) {
            const pages = document.querySelectorAll('.page');
            const targetPage = document.getElementById(pageId);
            
            if (!targetPage) return;
            
            // å…ˆéšè—æ‰€æœ‰é¡µé¢
            pages.forEach(page => {
                if (page.classList.contains('active')) {
                    page.classList.remove('active');
                }
            });
            
            // æ·»åŠ ä¸€ä¸ªå°çš„å»¶è¿Ÿï¼Œè®©CSSè¿‡æ¸¡æ•ˆæœç”Ÿæ•ˆ
            setTimeout(() => {
                targetPage.classList.add('active');
                
                // å¦‚æœæ˜¯è®°å½•é¡µé¢ï¼Œé‡æ–°æ¸²æŸ“è®°å½•
                if (pageId === 'recordsPage') {
                    renderRecords();
                }
            }, 50);
        }

        // åˆå§‹åŒ–UI
        function initUI() {
            // è®¾ç½®å½“å‰æ—¥æœŸä¸ºé»˜è®¤å€¼
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateInput').value = today;
            document.getElementById('exportDateFrom').value = today;
            document.getElementById('exportDateTo').value = today;
            
            // è®¾ç½®å½“å‰æ—¶é—´
            const now = new Date();
            const timeString = now.toTimeString().substr(0, 5);
            document.getElementById('timeInput').value = timeString;
        }

        // æ›´æ–°é¡¶éƒ¨æ—¶é—´æ˜¾ç¤º
        function updateTime() {
            const now = new Date();
            let timeString;
            let timezoneText;
            
            if (AppState.settings.timezone === 'UTC') {
                timeString = now.toUTCString().split(' ')[4];
                timezoneText = 'UTC';
            } else {
                // BJT (åŒ—äº¬æ—¶é—´)
                const beijingTime = new Date(now.getTime() + 8 * 60 * 60 * 1000);
                timeString = beijingTime.toISOString().substr(11, 8);
                timezoneText = 'BJT';
            }
            
            document.getElementById('currentTime').textContent = timeString;
            document.getElementById('currentTimezone').textContent = timezoneText;
            
            // æ›´æ–°å‘¼å·æ˜¾ç¤º
            const callsignElement = document.getElementById('headerCallsign');
            if (AppState.settings.myCallsign) {
                callsignElement.textContent = AppState.settings.myCallsign;
            } else {
                callsignElement.textContent = 'æœªè®¾ç½®å‘¼å·';
            }
        }

        // åˆå§‹åŒ–è‡ªå®šä¹‰é€‰æ‹©å™¨
        function initCustomSelectors() {
            const selectors = document.querySelectorAll('.custom-select');
            
            selectors.forEach(selector => {
                const header = selector.querySelector('.select-header');
                const options = selector.querySelector('.select-options');
                
                header.addEventListener('click', function(e) {
                    e.stopPropagation();
                    options.classList.toggle('active');
                });
                
                const optionElements = options.querySelectorAll('.select-option');
                optionElements.forEach(option => {
                    option.addEventListener('click', function() {
                        const value = this.getAttribute('data-value');
                        const displayText = this.textContent;
                        
                        // ç§»é™¤æ‰€æœ‰é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
                        optionElements.forEach(opt => opt.classList.remove('selected'));
                        // è®¾ç½®å½“å‰é€‰é¡¹ä¸ºé€‰ä¸­çŠ¶æ€
                        this.classList.add('selected');
                        
                        header.querySelector('span:first-child').textContent = displayText;
                        header.querySelector('span:first-child').setAttribute('data-value', value);
                        options.classList.remove('active');
                        
                        // å¦‚æœæ˜¯æ¯”èµ›é€‰æ‹©å™¨ï¼Œæ›´æ–°æ¯”èµ›å­—æ®µæ˜¾ç¤º
                        if (selector.id === 'contestSelect') {
                            updateContestFields();
                        }
                    });
                });
            });
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åŒºåŸŸå…³é—­é€‰æ‹©å™¨
            document.addEventListener('click', function() {
                selectors.forEach(selector => {
                    selector.querySelector('.select-options').classList.remove('active');
                });
            });
        }

        // æ›´æ–°æ¯”èµ›å­—æ®µæ˜¾ç¤º
        function updateContestFields() {
            const contest = document.getElementById('contestSelect').querySelector('span:first-child').getAttribute('data-value');
            const contestFields = document.getElementById('contestFields');
            
            if (contest) {
                contestFields.classList.add('active');
                
                // æ˜¾ç¤º/éšè—ç‰¹å®šå­—æ®µ
                document.getElementById('serialField').style.display = contest === 'CQ WPX' ? 'block' : 'none';
                document.getElementById('cqzoneField').style.display = contest === 'CQWW' ? 'block' : 'none';
                document.getElementById('qsosNumberField').style.display = contest === 'WAPC' ? 'block' : 'none';
                document.getElementById('provinceField').style.display = contest === 'WAPC' ? 'block' : 'none';
            } else {
                contestFields.classList.remove('active');
            }
        }

        // åˆ‡æ¢ç­›é€‰åŒºåŸŸ
        function toggleFilter() {
            const filterContent = document.getElementById('filterContent');
            const filterToggle = document.getElementById('filterToggle');
            
            filterContent.classList.toggle('collapsed');
            filterToggle.textContent = filterContent.classList.contains('collapsed') ? 'â–¶' : 'â–¼';
        }

        // åŠ è½½è®¾ç½®
        function loadSettings() {
            const savedSettings = localStorage.getItem('elves_settings');
            if (savedSettings) {
                AppState.settings = { ...AppState.settings, ...JSON.parse(savedSettings) };
                
                // æ›´æ–°UI
                document.getElementById('myCallsign').value = AppState.settings.myCallsign || '';
                document.getElementById('myGrid').value = AppState.settings.myGrid || '';
                document.getElementById('myCQZone').value = AppState.settings.myCQZone || '';
                document.getElementById('myITUZone').value = AppState.settings.myITUZone || '';
                document.getElementById('myEquipment').value = AppState.settings.myEquipment || '';
                document.getElementById('myAntenna').value = AppState.settings.myAntenna || '';
                
                // æ›´æ–°è‡ªå®šä¹‰é€‰æ‹©å™¨
                updateCustomSelector('timezoneSelect', AppState.settings.timezone || 'BJT');
                updateCustomSelector('languageSelect', AppState.settings.language || 'zh-CN');
                updateCustomSelector('themeSelect', AppState.settings.theme || 'light');
                
                // åº”ç”¨ä¸»é¢˜
                applyTheme(AppState.settings.theme);
                
                // æ›´æ–°è¯­è¨€
                updateLanguage(AppState.settings.language);
            }
        }

        // ä¿å­˜è®¾ç½®
        function saveSettings() {
            AppState.settings.myCallsign = document.getElementById('myCallsign').value.trim();
            AppState.settings.myGrid = document.getElementById('myGrid').value.trim();
            AppState.settings.myCQZone = document.getElementById('myCQZone').value.trim();
            AppState.settings.myITUZone = document.getElementById('myITUZone').value.trim();
            AppState.settings.myEquipment = document.getElementById('myEquipment').value.trim();
            AppState.settings.myAntenna = document.getElementById('myAntenna').value.trim();
            AppState.settings.timezone = getCustomSelectorValue('timezoneSelect');
            AppState.settings.language = getCustomSelectorValue('languageSelect');
            AppState.settings.theme = getCustomSelectorValue('themeSelect');
            
            localStorage.setItem('elves_settings', JSON.stringify(AppState.settings));
            
            // åº”ç”¨è®¾ç½®
            applyTheme(AppState.settings.theme);
            updateLanguage(AppState.settings.language);
            updateTime();
            
            showMessage('è®¾ç½®å·²ä¿å­˜', 'success');
        }

        // è·å–è‡ªå®šä¹‰é€‰æ‹©å™¨çš„å€¼
        function getCustomSelectorValue(selectorId) {
            const selector = document.getElementById(selectorId);
            if (!selector) return '';
            
            const selectedOption = selector.querySelector('.select-option.selected');
            return selectedOption ? selectedOption.getAttribute('data-value') : '';
        }

        // æ›´æ–°è‡ªå®šä¹‰é€‰æ‹©å™¨çš„å€¼
        function updateCustomSelector(selectorId, value) {
            const selector = document.getElementById(selectorId);
            if (!selector) return;
            
            // ç§»é™¤æ‰€æœ‰é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
            const options = selector.querySelectorAll('.select-option');
            options.forEach(option => option.classList.remove('selected'));
            
            // é€‰ä¸­æŒ‡å®šå€¼çš„é€‰é¡¹
            const targetOption = selector.querySelector(`.select-option[data-value="${value}"]`);
            if (targetOption) {
                targetOption.classList.add('selected');
                const header = selector.querySelector('.select-header');
                const displaySpan = header.querySelector('span:first-child');
                if (displaySpan) {
                    displaySpan.textContent = targetOption.textContent;
                    displaySpan.setAttribute('data-value', value);
                }
            }
        }

        // åº”ç”¨ä¸»é¢˜
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }

        // æ›´æ–°è¯­è¨€
        function updateLanguage(language) {
            // æ›´æ–°å¯¼èˆªæ–‡æœ¬
            const navTexts = document.querySelectorAll('.nav-text');
            const navLabels = ['è®°å½•', 'æ–°å¢', 'è®¾ç½®', 'å¯¼å‡º'];
            const navTranslations = {
                'zh-CN': ['è®°å½•', 'æ–°å¢', 'è®¾ç½®', 'å¯¼å‡º'],
                'zh-TW': ['è¨˜éŒ„', 'æ–°å¢', 'è¨­ç½®', 'å°å‡º'],
                'en': ['Records', 'Add', 'Settings', 'Export'],
                'ja': ['è¨˜éŒ²', 'è¿½åŠ ', 'è¨­å®š', 'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ']
            };
            
            navTexts.forEach((text, index) => {
                text.textContent = navTranslations[language]?.[index] || navLabels[index];
            });
            
            // æ›´æ–°é¡µé¢æ ‡é¢˜
            const pageTitles = document.querySelectorAll('h3');
            const titleTranslations = {
                'zh-CN': ['ç­›é€‰è®°å½•', 'æ–°å¢é€šè”è®°å½•', 'è®¾ç½®', 'å¯¼å‡ºè®°å½•'],
                'zh-TW': ['ç¯©é¸è¨˜éŒ„', 'æ–°å¢é€šè¯è¨˜éŒ„', 'è¨­ç½®', 'å°å‡ºè¨˜éŒ„'],
                'en': ['Filter Records', 'Add QSO Record', 'Settings', 'Export Records'],
                'ja': ['è¨˜éŒ²ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼', 'QSOè¨˜éŒ²ã‚’è¿½åŠ ', 'è¨­å®š', 'è¨˜éŒ²ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ']
            };
            
            pageTitles.forEach((title, index) => {
                title.textContent = titleTranslations[language]?.[index] || title.textContent;
            });
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(button => {
                const text = button.textContent;
                const translations = {
                    'zh-CN': {
                        'åº”ç”¨ç­›é€‰': 'åº”ç”¨ç­›é€‰',
                        'æ¸…é™¤ç­›é€‰': 'æ¸…é™¤ç­›é€‰',
                        'ä¿å­˜è®°å½•': 'ä¿å­˜è®°å½•',
                        'æ¸…ç©ºè¡¨å•': 'æ¸…ç©ºè¡¨å•',
                        'å¯¼å…¥æ–‡ä»¶': 'å¯¼å…¥æ–‡ä»¶',
                        'ä¿å­˜è®¾ç½®': 'ä¿å­˜è®¾ç½®',
                        'å…³äº': 'å…³äº',
                        'å¯¼å‡ºè®°å½•': 'å¯¼å‡ºè®°å½•',
                        'ç¡®è®¤': 'ç¡®è®¤',
                        'å–æ¶ˆ': 'å–æ¶ˆ',
                        'ä¿®æ”¹': 'ä¿®æ”¹',
                        'åˆ é™¤': 'åˆ é™¤',
                        'å…³é—­': 'å…³é—­'
                    },
                    'zh-TW': {
                        'åº”ç”¨ç­›é€‰': 'æ‡‰ç”¨ç¯©é¸',
                        'æ¸…é™¤ç­›é€‰': 'æ¸…é™¤ç¯©é¸',
                        'ä¿å­˜è®°å½•': 'ä¿å­˜è¨˜éŒ„',
                        'æ¸…ç©ºè¡¨å•': 'æ¸…ç©ºè¡¨å–®',
                        'å¯¼å…¥æ–‡ä»¶': 'å°å…¥æ–‡ä»¶',
                        'ä¿å­˜è®¾ç½®': 'ä¿å­˜è¨­ç½®',
                        'å…³äº': 'é—œæ–¼',
                        'å¯¼å‡ºè®°å½•': 'å°å‡ºè¨˜éŒ„',
                        'ç¡®è®¤': 'ç¢ºèª',
                        'å–æ¶ˆ': 'å–æ¶ˆ',
                        'ä¿®æ”¹': 'ä¿®æ”¹',
                        'åˆ é™¤': 'åˆªé™¤',
                        'å…³é—­': 'é—œé–‰'
                    },
                    'en': {
                        'åº”ç”¨ç­›é€‰': 'Apply Filter',
                        'æ¸…é™¤ç­›é€‰': 'Clear Filter',
                        'ä¿å­˜è®°å½•': 'Save Record',
                        'æ¸…ç©ºè¡¨å•': 'Clear Form',
                        'å¯¼å…¥æ–‡ä»¶': 'Import File',
                        'ä¿å­˜è®¾ç½®': 'Save Settings',
                        'å…³äº': 'About',
                        'å¯¼å‡ºè®°å½•': 'Export Records',
                        'ç¡®è®¤': 'Confirm',
                        'å–æ¶ˆ': 'Cancel',
                        'ä¿®æ”¹': 'Edit',
                        'åˆ é™¤': 'Delete',
                        'å…³é—­': 'Close'
                    },
                    'ja': {
                        'åº”ç”¨ç­›é€‰': 'ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨',
                        'æ¸…é™¤ç­›é€‰': 'ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢',
                        'ä¿å­˜è®°å½•': 'è¨˜éŒ²ã‚’ä¿å­˜',
                        'æ¸…ç©ºè¡¨å•': 'ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢',
                        'å¯¼å…¥æ–‡ä»¶': 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ',
                        'ä¿å­˜è®¾ç½®': 'è¨­å®šã‚’ä¿å­˜',
                        'å…³äº': 'ã«ã¤ã„ã¦',
                        'å¯¼å‡ºè®°å½•': 'è¨˜éŒ²ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ',
                        'ç¡®è®¤': 'ç¢ºèª',
                        'å–æ¶ˆ': 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
                        'ä¿®æ”¹': 'ç·¨é›†',
                        'åˆ é™¤': 'å‰Šé™¤',
                        'å…³é—­': 'é–‰ã˜ã‚‹'
                    }
                };
                
                if (translations[language] && translations[language][text]) {
                    button.textContent = translations[language][text];
                }
            });
            
            // æ›´æ–°æ ‡ç­¾æ–‡æœ¬
            const labels = document.querySelectorAll('label');
            labels.forEach(label => {
                const text = label.textContent.replace(' *', '');
                const translations = {
                    'zh-CN': {
                        'å¼€å§‹æ—¥æœŸ': 'å¼€å§‹æ—¥æœŸ',
                        'ç»“æŸæ—¥æœŸ': 'ç»“æŸæ—¥æœŸ',
                        'å‘¼å·': 'å‘¼å·',
                        'ç½‘æ ¼': 'ç½‘æ ¼',
                        'æ¯”èµ›ç±»å‹': 'æ¯”èµ›ç±»å‹',
                        'å¯¹æ–¹å‘¼å·': 'å¯¹æ–¹å‘¼å·',
                        'é¢‘ç‡': 'é¢‘ç‡',
                        'æ¨¡å¼': 'æ¨¡å¼',
                        'æ—¥æœŸ': 'æ—¥æœŸ',
                        'æ—¶é—´': 'æ—¶é—´',
                        'RST å‘é€': 'RST å‘é€',
                        'RST æ¥æ”¶': 'RST æ¥æ”¶',
                        'å§“å': 'å§“å',
                        'QTH': 'QTH',
                        'å¯¹æ–¹è®¾å¤‡': 'å¯¹æ–¹è®¾å¤‡',
                        'å¯¹æ–¹å¤©çº¿': 'å¯¹æ–¹å¤©çº¿',
                        'å¤‡æ³¨': 'å¤‡æ³¨',
                        'åºåˆ—å·': 'åºåˆ—å·',
                        'CQåˆ†åŒº': 'CQåˆ†åŒº',
                        'QSOåºå·': 'QSOåºå·',
                        'çœå¸‚åŒºç¼©å†™': 'çœå¸‚åŒºç¼©å†™',
                        'æˆ‘çš„å‘¼å·': 'æˆ‘çš„å‘¼å·',
                        'æˆ‘çš„GRIDç½‘æ ¼': 'æˆ‘çš„GRIDç½‘æ ¼',
                        'æˆ‘çš„CQåˆ†åŒº': 'æˆ‘çš„CQåˆ†åŒº',
                        'æˆ‘çš„ITUåˆ†åŒº': 'æˆ‘çš„ITUåˆ†åŒº',
                        'ä½¿ç”¨è®¾å¤‡': 'ä½¿ç”¨è®¾å¤‡',
                        'ä½¿ç”¨å¤©çº¿': 'ä½¿ç”¨å¤©çº¿',
                        'æ—¶åŒºæ˜¾ç¤º': 'æ—¶åŒºæ˜¾ç¤º',
                        'ç•Œé¢è¯­è¨€': 'ç•Œé¢è¯­è¨€',
                        'ä¸»é¢˜æ¨¡å¼': 'ä¸»é¢˜æ¨¡å¼',
                        'æ–‡ä»¶å': 'æ–‡ä»¶å',
                        'æ–‡ä»¶æ ¼å¼': 'æ–‡ä»¶æ ¼å¼'
                    },
                    'zh-TW': {
                        'å¼€å§‹æ—¥æœŸ': 'é–‹å§‹æ—¥æœŸ',
                        'ç»“æŸæ—¥æœŸ': 'çµæŸæ—¥æœŸ',
                        'å‘¼å·': 'å‘¼è™Ÿ',
                        'ç½‘æ ¼': 'ç¶²æ ¼',
                        'æ¯”èµ›ç±»å‹': 'æ¯”è³½é¡å‹',
                        'å¯¹æ–¹å‘¼å·': 'å°æ–¹å‘¼è™Ÿ',
                        'é¢‘ç‡': 'é »ç‡',
                        'æ¨¡å¼': 'æ¨¡å¼',
                        'æ—¥æœŸ': 'æ—¥æœŸ',
                        'æ—¶é—´': 'æ™‚é–“',
                        'RST å‘é€': 'RST ç™¼é€',
                        'RST æ¥æ”¶': 'RST æ¥æ”¶',
                        'å§“å': 'å§“å',
                        'QTH': 'QTH',
                        'å¯¹æ–¹è®¾å¤‡': 'å°æ–¹è¨­å‚™',
                        'å¯¹æ–¹å¤©çº¿': 'å°æ–¹å¤©ç·š',
                        'å¤‡æ³¨': 'å‚™è¨»',
                        'åºåˆ—å·': 'åºåˆ—è™Ÿ',
                        'CQåˆ†åŒº': 'CQåˆ†å€',
                        'QSOåºå·': 'QSOåºè™Ÿ',
                        'çœå¸‚åŒºç¼©å†™': 'çœå¸‚å€ç¸®å¯«',
                        'æˆ‘çš„å‘¼å·': 'æˆ‘çš„å‘¼è™Ÿ',
                        'æˆ‘çš„GRIDç½‘æ ¼': 'æˆ‘çš„GRIDç¶²æ ¼',
                        'æˆ‘çš„CQåˆ†åŒº': 'æˆ‘çš„CQåˆ†å€',
                        'æˆ‘çš„ITUåˆ†åŒº': 'æˆ‘çš„ITUåˆ†å€',
                        'ä½¿ç”¨è®¾å¤‡': 'ä½¿ç”¨è¨­å‚™',
                        'ä½¿ç”¨å¤©çº¿': 'ä½¿ç”¨å¤©ç·š',
                        'æ—¶åŒºæ˜¾ç¤º': 'æ™‚å€é¡¯ç¤º',
                        'ç•Œé¢è¯­è¨€': 'ç•Œé¢èªè¨€',
                        'ä¸»é¢˜æ¨¡å¼': 'ä¸»é¡Œæ¨¡å¼',
                        'æ–‡ä»¶å': 'æ–‡ä»¶å',
                        'æ–‡ä»¶æ ¼å¼': 'æ–‡ä»¶æ ¼å¼'
                    },
                    'en': {
                        'å¼€å§‹æ—¥æœŸ': 'Start Date',
                        'ç»“æŸæ—¥æœŸ': 'End Date',
                        'å‘¼å·': 'Callsign',
                        'ç½‘æ ¼': 'Grid',
                        'æ¯”èµ›ç±»å‹': 'Contest Type',
                        'å¯¹æ–¹å‘¼å·': 'Callsign',
                        'é¢‘ç‡': 'Frequency',
                        'æ¨¡å¼': 'Mode',
                        'æ—¥æœŸ': 'Date',
                        'æ—¶é—´': 'Time',
                        'RST å‘é€': 'RST Sent',
                        'RST æ¥æ”¶': 'RST Received',
                        'å§“å': 'Name',
                        'QTH': 'QTH',
                        'å¯¹æ–¹è®¾å¤‡': 'Their Equipment',
                        'å¯¹æ–¹å¤©çº¿': 'Their Antenna',
                        'å¤‡æ³¨': 'Comment',
                        'åºåˆ—å·': 'Serial Number',
                        'CQåˆ†åŒº': 'CQ Zone',
                        'QSOåºå·': 'QSO Number',
                        'çœå¸‚åŒºç¼©å†™': 'Province',
                        'æˆ‘çš„å‘¼å·': 'My Callsign',
                        'æˆ‘çš„GRIDç½‘æ ¼': 'My GRID',
                        'æˆ‘çš„CQåˆ†åŒº': 'My CQ Zone',
                        'æˆ‘çš„ITUåˆ†åŒº': 'My ITU Zone',
                        'ä½¿ç”¨è®¾å¤‡': 'My Equipment',
                        'ä½¿ç”¨å¤©çº¿': 'My Antenna',
                        'æ—¶åŒºæ˜¾ç¤º': 'Timezone',
                        'ç•Œé¢è¯­è¨€': 'Language',
                        'ä¸»é¢˜æ¨¡å¼': 'Theme',
                        'æ–‡ä»¶å': 'Filename',
                        'æ–‡ä»¶æ ¼å¼': 'File Format'
                    },
                    'ja': {
                        'å¼€å§‹æ—¥æœŸ': 'é–‹å§‹æ—¥',
                        'ç»“æŸæ—¥æœŸ': 'çµ‚äº†æ—¥',
                        'å‘¼å·': 'ã‚³ãƒ¼ãƒ«ã‚µã‚¤ãƒ³',
                        'ç½‘æ ¼': 'ã‚°ãƒªãƒƒãƒ‰',
                        'æ¯”èµ›ç±»å‹': 'ã‚³ãƒ³ãƒ†ã‚¹ãƒˆã‚¿ã‚¤ãƒ—',
                        'å¯¹æ–¹å‘¼å·': 'ã‚³ãƒ¼ãƒ«ã‚µã‚¤ãƒ³',
                        'é¢‘ç‡': 'å‘¨æ³¢æ•°',
                        'æ¨¡å¼': 'ãƒ¢ãƒ¼ãƒ‰',
                        'æ—¥æœŸ': 'æ—¥ä»˜',
                        'æ—¶é—´': 'æ™‚é–“',
                        'RST å‘é€': 'RSTé€ä¿¡',
                        'RST æ¥æ”¶': 'RSTå—ä¿¡',
                        'å§“å': 'åå‰',
                        'QTH': 'QTH',
                        'å¯¹æ–¹è®¾å¤‡': 'ç›¸æ‰‹ã®æ©Ÿæ',
                        'å¯¹æ–¹å¤©çº¿': 'ç›¸æ‰‹ã®ã‚¢ãƒ³ãƒ†ãƒŠ',
                        'å¤‡æ³¨': 'ã‚³ãƒ¡ãƒ³ãƒˆ',
                        'åºåˆ—å·': 'ã‚·ãƒªã‚¢ãƒ«ç•ªå·',
                        'CQåˆ†åŒº': 'CQã‚¾ãƒ¼ãƒ³',
                        'QSOåºå·': 'QSOç•ªå·',
                        'çœå¸‚åŒºç¼©å†™': 'éƒ½é“åºœçœŒ',
                        'æˆ‘çš„å‘¼å·': 'ç§ã®ã‚³ãƒ¼ãƒ«ã‚µã‚¤ãƒ³',
                        'æˆ‘çš„GRIDç½‘æ ¼': 'ç§ã®ã‚°ãƒªãƒƒãƒ‰',
                        'æˆ‘çš„CQåˆ†åŒº': 'ç§ã®CQã‚¾ãƒ¼ãƒ³',
                        'æˆ‘çš„ITUåˆ†åŒº': 'ç§ã®ITUã‚¾ãƒ¼ãƒ³',
                        'ä½¿ç”¨è®¾å¤‡': 'ç§ã®æ©Ÿæ',
                        'ä½¿ç”¨å¤©çº¿': 'ç§ã®ã‚¢ãƒ³ãƒ†ãƒŠ',
                        'æ—¶åŒºæ˜¾ç¤º': 'ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³',
                        'ç•Œé¢è¯­è¨€': 'è¨€èª',
                        'ä¸»é¢˜æ¨¡å¼': 'ãƒ†ãƒ¼ãƒ',
                        'æ–‡ä»¶å': 'ãƒ•ã‚¡ã‚¤ãƒ«å',
                        'æ–‡ä»¶æ ¼å¼': 'ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼'
                    }
                };
                
                if (translations[language] && translations[language][text]) {
                    label.textContent = translations[language][text] + (label.textContent.includes('*') ? ' *' : '');
                }
            });
        }

        // åŠ è½½è®°å½•
        function loadRecords() {
            const savedRecords = localStorage.getItem('elves_records');
            if (savedRecords) {
                AppState.records = JSON.parse(savedRecords);
            }
        }

        // ä¿å­˜è®°å½•
        function saveRecords() {
            localStorage.setItem('elves_records', JSON.stringify(AppState.records));
        }

        // æ¸²æŸ“è®°å½•
        function renderRecords() {
            const container = document.getElementById('recordsContainer');
            let filteredRecords = [...AppState.records];
            
            // åº”ç”¨ç­›é€‰
            if (AppState.filters.dateFrom) {
                filteredRecords = filteredRecords.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate >= new Date(AppState.filters.dateFrom);
                });
            }
            
            if (AppState.filters.dateTo) {
                filteredRecords = filteredRecords.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate <= new Date(AppState.filters.dateTo);
                });
            }
            
            if (AppState.filters.callsign) {
                filteredRecords = filteredRecords.filter(record => 
                    record.callsign.toLowerCase().includes(AppState.filters.callsign.toLowerCase())
                );
            }
            
            if (AppState.filters.grid) {
                filteredRecords = filteredRecords.filter(record => 
                    record.gridsquare && record.gridsquare.toLowerCase().includes(AppState.filters.grid.toLowerCase())
                );
            }
            
            if (AppState.filters.contest) {
                filteredRecords = filteredRecords.filter(record => 
                    record.contest === AppState.filters.contest
                );
            }
            
            // æŒ‰æ—¥æœŸå€’åºæ’åº
            filteredRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';
            
            // å¦‚æœæ²¡æœ‰è®°å½•ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
            if (filteredRecords.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“</div>
                        <div class="empty-text">${getTranslation('noRecords')}</div>
                        <div class="empty-subtext">${getTranslation('addRecordHint')}</div>
                    </div>
                `;
                return;
            }
            
            // æ¸²æŸ“è®°å½•å¡ç‰‡
            filteredRecords.forEach((record, index) => {
                const card = document.createElement('div');
                card.className = 'record-card';
                card.style.margin = '10px 15px'; // ä¸ä¸¤è¾¹ä¿æŒè·ç¦»
                
                const contestBadge = record.contest ? `<span class="contest-badge">${record.contest}</span>` : '';
                
                card.innerHTML = `
                    <div class="record-summary">
                        <div>
                            <span class="record-callsign">${record.callsign}</span>
                            ${contestBadge}
                        </div>
                        <div class="record-info">
                            <div>${record.frequency} MHz</div>
                            <div>${formatDateTime(record.date, record.time)}</div>
                            <div>${record.mode}</div>
                        </div>
                    </div>
                    <div class="record-details">
                        <div class="detail-row">
                            <span class="detail-label">é¢‘ç‡:</span>
                            <span class="detail-value">${record.frequency} MHz</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">æ¨¡å¼:</span>
                            <span class="detail-value">${record.mode}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">æ—¥æœŸæ—¶é—´:</span>
                            <span class="detail-value">${formatDateTime(record.date, record.time)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">RSTå‘é€:</span>
                            <span class="detail-value">${record.rstSent || '-'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">RSTæ¥æ”¶:</span>
                            <span class="detail-value">${record.rstRcvd || '-'}</span>
                        </div>
                        ${record.contest ? `<div class="detail-row">
                            <span class="detail-label">æ¯”èµ›:</span>
                            <span class="detail-value">${record.contest}</span>
                        </div>` : ''}
                        ${record.serial ? `<div class="detail-row">
                            <span class="detail-label">åºåˆ—å·:</span>
                            <span class="detail-value">${record.serial}</span>
                        </div>` : ''}
                        ${record.cqzone ? `<div class="detail-row">
                            <span class="detail-label">CQåˆ†åŒº:</span>
                            <span class="detail-value">${record.cqzone}</span>
                        </div>` : ''}
                        ${record.qsosNumber ? `<div class="detail-row">
                            <span class="detail-label">QSOåºå·:</span>
                            <span class="detail-value">${record.qsosNumber}</span>
                        </div>` : ''}
                        ${record.province ? `<div class="detail-row">
                            <span class="detail-label">çœå¸‚åŒº:</span>
                            <span class="detail-value">${record.province}</span>
                        </div>` : ''}
                        ${record.name ? `<div class="detail-row">
                            <span class="detail-label">å§“å:</span>
                            <span class="detail-value">${record.name}</span>
                        </div>` : ''}
                        ${record.qth ? `<div class="detail-row">
                            <span class="detail-label">QTH:</span>
                            <span class="detail-value">${record.qth}</span>
                        </div>` : ''}
                        ${record.gridsquare ? `<div class="detail-row">
                            <span class="detail-label">ç½‘æ ¼:</span>
                            <span class="detail-value">${record.gridsquare}</span>
                        </div>` : ''}
                        ${record.theirEquipment ? `<div class="detail-row">
                            <span class="detail-label">å¯¹æ–¹è®¾å¤‡:</span>
                            <span class="detail-value">${record.theirEquipment}</span>
                        </div>` : ''}
                        ${record.theirAntenna ? `<div class="detail-row">
                            <span class="detail-label">å¯¹æ–¹å¤©çº¿:</span>
                            <span class="detail-value">${record.theirAntenna}</span>
                        </div>` : ''}
                        ${record.comment ? `<div class="detail-row">
                            <span class="detail-label">å¤‡æ³¨:</span>
                            <span class="detail-value">${record.comment}</span>
                        </div>` : ''}
                        <div class="record-actions">
                            <button class="btn btn-primary edit-btn" data-index="${index}">ä¿®æ”¹</button>
                            <button class="btn btn-danger delete-btn" data-index="${index}">åˆ é™¤</button>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                const summary = card.querySelector('.record-summary');
                summary.addEventListener('click', function() {
                    card.classList.toggle('expanded');
                });
                
                // æ·»åŠ åˆ é™¤æŒ‰é’®äº‹ä»¶
                const deleteBtn = card.querySelector('.delete-btn');
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const recordIndex = parseInt(this.getAttribute('data-index'));
                    showConfirmation(getTranslation('deleteConfirm'), () => {
                        deleteRecord(recordIndex);
                    });
                });
                
                // æ·»åŠ ç¼–è¾‘æŒ‰é’®äº‹ä»¶
                const editBtn = card.querySelector('.edit-btn');
                editBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const recordIndex = parseInt(this.getAttribute('data-index'));
                    editRecord(recordIndex);
                });
            });
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(dateStr, timeStr) {
            const date = new Date(dateStr);
            const formattedDate = date.toLocaleDateString('zh-CN');
            return `${formattedDate} ${timeStr}`;
        }

        // ä¿å­˜è®°å½•
        function saveRecord() {
            // è·å–è¡¨å•æ•°æ®
            const record = {
                callsign: document.getElementById('callsign').value.trim(),
                frequency: document.getElementById('frequency').value.trim(),
                mode: document.getElementById('modeSelect').querySelector('span:first-child').getAttribute('data-value'),
                date: document.getElementById('dateInput').value,
                time: document.getElementById('timeInput').value,
                rstSent: document.getElementById('rstSent').value.trim(),
                rstRcvd: document.getElementById('rstRcvd').value.trim(),
                name: document.getElementById('name').value.trim(),
                qth: document.getElementById('qth').value.trim(),
                gridsquare: document.getElementById('gridsquare').value.trim(),
                theirEquipment: document.getElementById('theirEquipment').value.trim(),
                theirAntenna: document.getElementById('theirAntenna').value.trim(),
                comment: document.getElementById('comment').value.trim(),
                contest: document.getElementById('contestSelect').querySelector('span:first-child').getAttribute('data-value') || '',
                serial: document.getElementById('serial').value.trim(),
                cqzone: document.getElementById('cqzone').value.trim(),
                qsosNumber: document.getElementById('qsosNumber').value.trim(),
                province: document.getElementById('province').value.trim()
            };
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!record.callsign || !record.frequency || !record.date || !record.time) {
                showMessage('è¯·å¡«å†™å¿…å¡«å­—æ®µï¼šå¯¹æ–¹å‘¼å·ã€é¢‘ç‡ã€æ—¥æœŸå’Œæ—¶é—´', 'warning');
                return;
            }
            
            // æ£€æŸ¥é‡å¤è®°å½•
            const isDuplicate = AppState.records.some(existingRecord => 
                existingRecord.callsign === record.callsign &&
                existingRecord.date === record.date &&
                existingRecord.time === record.time &&
                existingRecord.frequency === record.frequency
            );
            
            if (isDuplicate && !AppState.currentEditingRecord) {
                showConfirmation(getTranslation('duplicateConfirm'), () => {
                    addRecord(record);
                });
                return;
            }
            
            if (AppState.currentEditingRecord !== null) {
                // ç¼–è¾‘æ¨¡å¼
                showConfirmation(getTranslation('editConfirm'), () => {
                    updateRecord(record);
                });
            } else {
                // æ–°å¢æ¨¡å¼
                addRecord(record);
            }
        }

        // æ·»åŠ è®°å½•
        function addRecord(record) {
            AppState.records.push(record);
            saveRecords();
            renderRecords();
            clearForm();
            switchPage('recordsPage');
            showMessage('è®°å½•å·²ä¿å­˜', 'success');
        }

        // æ›´æ–°è®°å½•
        function updateRecord(record) {
            AppState.records[AppState.currentEditingRecord] = record;
            saveRecords();
            renderRecords();
            clearForm();
            AppState.currentEditingRecord = null;
            switchPage('recordsPage');
            showMessage('è®°å½•å·²æ›´æ–°', 'success');
        }

        // ç¼–è¾‘è®°å½•
        function editRecord(index) {
            const record = AppState.records[index];
            AppState.currentEditingRecord = index;
            
            // å¡«å……è¡¨å•
            document.getElementById('callsign').value = record.callsign;
            document.getElementById('frequency').value = record.frequency;
            
            // è®¾ç½®æ¨¡å¼é€‰æ‹©å™¨
            const modeSelect = document.getElementById('modeSelect');
            const modeSpan = modeSelect.querySelector('span:first-child');
            modeSpan.textContent = record.mode;
            modeSpan.setAttribute('data-value', record.mode);
            
            document.getElementById('dateInput').value = record.date;
            document.getElementById('timeInput').value = record.time;
            document.getElementById('rstSent').value = record.rstSent || '';
            document.getElementById('rstRcvd').value = record.rstRcvd || '';
            document.getElementById('name').value = record.name || '';
            document.getElementById('qth').value = record.qth || '';
            document.getElementById('gridsquare').value = record.gridsquare || '';
            document.getElementById('theirEquipment').value = record.theirEquipment || '';
            document.getElementById('theirAntenna').value = record.theirAntenna || '';
            document.getElementById('comment').value = record.comment || '';
            
            // è®¾ç½®æ¯”èµ›é€‰æ‹©å™¨
            const contestSelect = document.getElementById('contestSelect');
            const contestSpan = contestSelect.querySelector('span:first-child');
            contestSpan.textContent = record.contest || 'æ— ';
            contestSpan.setAttribute('data-value', record.contest || '');
            
            document.getElementById('serial').value = record.serial || '';
            document.getElementById('cqzone').value = record.cqzone || '';
            document.getElementById('qsosNumber').value = record.qsosNumber || '';
            document.getElementById('province').value = record.province || '';
            
            // æ›´æ–°æ¯”èµ›å­—æ®µæ˜¾ç¤º
            updateContestFields();
            
            // åˆ‡æ¢åˆ°æ–°å¢é¡µé¢
            switchPage('addPage');
        }

        // åˆ é™¤è®°å½•
        function deleteRecord(index) {
            AppState.records.splice(index, 1);
            saveRecords();
            renderRecords();
        }

        // æ¸…ç©ºè¡¨å•
        function clearForm() {
            document.getElementById('callsign').value = '';
            document.getElementById('frequency').value = '';
            
            const modeSelect = document.getElementById('modeSelect');
            const modeSpan = modeSelect.querySelector('span:first-child');
            modeSpan.textContent = 'SSB';
            modeSpan.setAttribute('data-value', 'SSB');
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateInput').value = today;
            
            const now = new Date();
            const timeString = now.toTimeString().substr(0, 5);
            document.getElementById('timeInput').value = timeString;
            
            document.getElementById('rstSent').value = '';
            document.getElementById('rstRcvd').value = '';
            document.getElementById('name').value = '';
            document.getElementById('qth').value = '';
            document.getElementById('gridsquare').value = '';
            document.getElementById('theirEquipment').value = '';
            document.getElementById('theirAntenna').value = '';
            document.getElementById('comment').value = '';
            
            const contestSelect = document.getElementById('contestSelect');
            const contestSpan = contestSelect.querySelector('span:first-child');
            contestSpan.textContent = 'æ— ';
            contestSpan.setAttribute('data-value', '');
            
            document.getElementById('serial').value = '';
            document.getElementById('cqzone').value = '';
            document.getElementById('qsosNumber').value = '';
            document.getElementById('province').value = '';
            
            updateContestFields();
            AppState.currentEditingRecord = null;
        }

        // åº”ç”¨ç­›é€‰
        function applyFilters() {
            AppState.filters.dateFrom = document.getElementById('filterDateFrom').value || null;
            AppState.filters.dateTo = document.getElementById('filterDateTo').value || null;
            AppState.filters.callsign = document.getElementById('filterCallsign').value;
            AppState.filters.grid = document.getElementById('filterGrid').value;
            AppState.filters.contest = document.getElementById('filterContest').value;
            
            renderRecords();
        }

        // æ¸…é™¤ç­›é€‰
        function clearFilters() {
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('filterCallsign').value = '';
            document.getElementById('filterGrid').value = '';
            document.getElementById('filterContest').value = '';
            
            AppState.filters.dateFrom = null;
            AppState.filters.dateTo = null;
            AppState.filters.callsign = '';
            AppState.filters.grid = '';
            AppState.filters.contest = '';
            
            renderRecords();
        }

        // å¯¼å…¥æ–‡ä»¶
        function importFile() {
            document.getElementById('fileInput').click();
        }

        // æ–‡ä»¶è¾“å…¥å˜åŒ–
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const content = event.target.result;
                const records = parseImportFile(content, file.name);
                
                if (records.length > 0) {
                    // æ£€æŸ¥é‡å¤è®°å½•
                    const uniqueRecords = [];
                    const duplicateRecords = [];
                    
                    records.forEach(record => {
                        const isDuplicate = AppState.records.some(existingRecord => 
                            existingRecord.callsign === record.callsign &&
                            existingRecord.date === record.date &&
                            existingRecord.time === record.time &&
                            existingRecord.frequency === record.frequency
                        );
                        
                        if (!isDuplicate) {
                            uniqueRecords.push(record);
                        } else {
                            duplicateRecords.push(record);
                        }
                    });
                    
                    if (duplicateRecords.length > 0 && uniqueRecords.length > 0) {
                        showConfirmation(getTranslation('importPartial'), () => {
                            // åªå¯¼å…¥ä¸é‡å¤çš„è®°å½•
                            AppState.records.push(...uniqueRecords);
                            saveRecords();
                            renderRecords();
                            showMessage(`æˆåŠŸå¯¼å…¥ ${uniqueRecords.length} æ¡è®°å½•ï¼Œè·³è¿‡ ${duplicateRecords.length} æ¡é‡å¤è®°å½•`, 'success');
                        });
                    } else if (duplicateRecords.length > 0) {
                        showConfirmation(getTranslation('duplicateConfirm'), () => {
                            // å¯¼å…¥æ‰€æœ‰è®°å½•ï¼ˆåŒ…å«é‡å¤ï¼‰
                            AppState.records.push(...records);
                            saveRecords();
                            renderRecords();
                            showMessage(`æˆåŠŸå¯¼å…¥ ${records.length} æ¡è®°å½•`, 'success');
                        });
                    } else {
                        // æ²¡æœ‰é‡å¤è®°å½•
                        showConfirmation(getTranslation('importConfirm'), () => {
                            AppState.records.push(...records);
                            saveRecords();
                            renderRecords();
                            showMessage(`æˆåŠŸå¯¼å…¥ ${records.length} æ¡è®°å½•`, 'success');
                        });
                    }
                } else {
                    showMessage('æœªæ‰¾åˆ°æœ‰æ•ˆçš„è®°å½•', 'warning');
                }
            };
            
            reader.readAsText(file);
            
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            e.target.value = '';
        });

        // è§£æå¯¼å…¥æ–‡ä»¶
        function parseImportFile(content, filename) {
            const records = [];
            
            if (filename.toLowerCase().endsWith('.adi')) {
                // ADIæ ¼å¼è§£æ
                const lines = content.split('\n');
                let currentRecord = {};
                let inHeader = true;
                
                for (let line of lines) {
                    line = line.trim();
                    if (!line) continue;
                    
                    if (line === '<EOH>' || line === '<eor>') {
                        inHeader = false;
                        continue;
                    }
                    
                    if (line === '<EOR>' || line === '<eor>') {
                        if (Object.keys(currentRecord).length > 0) {
                            records.push(processAdiRecord(currentRecord));
                            currentRecord = {};
                        }
                        continue;
                    }
                    
                    if (line.startsWith('<') && line.includes('>')) {
                        if (inHeader) continue; // è·³è¿‡å¤´éƒ¨ä¿¡æ¯
                        
                        const tagMatch = line.match(/^<(\w+):(\d+)>(.*)$/);
                        if (tagMatch) {
                            const [, tag, length, value] = tagMatch;
                            currentRecord[tag] = value.trim();
                        }
                    }
                }
                
                if (Object.keys(currentRecord).length > 0) {
                    records.push(processAdiRecord(currentRecord));
                }
            } else if (filename.toLowerCase().endsWith('.log') || filename.toLowerCase().endsWith('.txt')) {
                // Cabrilloæ ¼å¼è§£æ
                const lines = content.split('\n');
                
                for (let line of lines) {
                    if (line.startsWith('QSO:')) {
                        const parts = line.split(/\s+/);
                        if (parts.length >= 8) {
                            const record = {
                                frequency: parts[2],
                                mode: parts[3],
                                date: formatCabrilloDate(parts[4]),
                                time: parts[5].substr(0, 2) + ':' + parts[5].substr(2, 2),
                                callsign: parts[7],
                                rstSent: parts[6],
                                rstRcvd: parts[8] || '59'
                            };
                            
                            // å°è¯•è§£ææ¯”èµ›ä¿¡æ¯
                            if (parts.length > 9) {
                                if (parts[9].match(/^\d+$/)) {
                                    record.serial = parts[9];
                                    record.contest = 'CQ WPX';
                                } else if (parts[9].match(/^\d{1,2}$/)) {
                                    record.cqzone = parts[9];
                                    record.contest = 'CQWW';
                                }
                            }
                            
                            records.push(record);
                        }
                    }
                }
            }
            
            return records;
        }

        // å¤„ç†ADIè®°å½•
        function processAdiRecord(record) {
            // æ ¼å¼åŒ–æ—¥æœŸï¼šYYYYMMDD -> YYYY-MM-DD
            let formattedDate = '';
            if (record.QSO_DATE && record.QSO_DATE.length === 8) {
                formattedDate = record.QSO_DATE.substr(0, 4) + '-' + 
                               record.QSO_DATE.substr(4, 2) + '-' + 
                               record.QSO_DATE.substr(6, 2);
            }
            
            // æ ¼å¼åŒ–æ—¶é—´ï¼šHHMM -> HH:MM
            let formattedTime = '';
            if (record.TIME_ON && record.TIME_ON.length === 4) {
                formattedTime = record.TIME_ON.substr(0, 2) + ':' + 
                               record.TIME_ON.substr(2, 2);
            }
            
            // æ£€æµ‹æ˜¯å¦ä¸ºFT8ç›¸å…³è®°å½•
            const isFT8Related = record.MODE && (record.MODE.includes('FT8') || record.MODE.includes('FT4') || 
                               record.MODE.includes('JT65') || record.MODE.includes('JT9') ||
                               record.SRX_STRING || record.STX_STRING || record.SIG_INFO);
            
            // å¤„ç†FT8ç‰¹æ®Šå­—æ®µ
            let ft8Fields = {};
            if (isFT8Related) {
                // WSJT-Xç‰¹æœ‰å­—æ®µæ˜ å°„
                ft8Fields = {
                    signalReport: record.SRX_STRING || record.STX_STRING || '',
                    distance: record.DISTANCE || '',
                    azimuth: record.AZ || '',
                    snr: record.SNR || '',
                    sigInfo: record.SIG_INFO || '',
                    txPower: record.TX_PWR || '',
                    software: record.SOFTWARE || 'WSJT-X'
                };
                
                // å¦‚æœæ¨¡å¼æ˜¯FT8ä½†æœªæŒ‡å®šï¼Œè‡ªåŠ¨è®¾ç½®ä¸ºFT8
                if (!record.MODE && (record.SOFTWARE || '').includes('WSJT')) {
                    record.MODE = 'FT8';
                }
            }
            
            return {
                callsign: record.CALL || '',
                frequency: record.FREQ || '',
                mode: record.MODE || 'SSB',
                date: formattedDate || record.QSO_DATE || '',
                time: formattedTime || record.TIME_ON || '',
                rstSent: record.RST_SENT || '',
                rstRcvd: record.RST_RCVD || '',
                name: record.NAME || '',
                qth: record.QTH || '',
                gridsquare: record.GRIDSQUARE || '',
                comment: record.COMMENT || '',
                ...ft8Fields,
                isFT8: isFT8Related
            };
        }

        // æ ¼å¼åŒ–Cabrilloæ—¥æœŸ
        function formatCabrilloDate(cabrilloDate) {
            if (cabrilloDate.length === 8) {
                return cabrilloDate.substr(0, 4) + '-' + cabrilloDate.substr(4, 2) + '-' + cabrilloDate.substr(6, 2);
            }
            return cabrilloDate;
        }

        // å¯¼å‡ºè®°å½•
        function exportRecords() {
            const dateFrom = document.getElementById('exportDateFrom').value;
            const dateTo = document.getElementById('exportDateTo').value;
            const contest = getCustomSelectorValue('exportContestSelect');
            const format = getCustomSelectorValue('exportFormatSelect');
            const filename = document.getElementById('exportFilename').value || 'elves_log';
            
            // ç­›é€‰è®°å½•
            let recordsToExport = [...AppState.records];
            
            if (dateFrom) {
                recordsToExport = recordsToExport.filter(record => 
                    new Date(record.date) >= new Date(dateFrom)
                );
            }
            
            if (dateTo) {
                recordsToExport = recordsToExport.filter(record => 
                    new Date(record.date) <= new Date(dateTo)
                );
            }
            
            if (contest) {
                recordsToExport = recordsToExport.filter(record => record.contest === contest);
            }
            
            if (recordsToExport.length === 0) {
                showMessage('æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„è®°å½•', 'warning');
                return;
            }
            
            let content, fileExtension;
            
            if (format === 'adi') {
                content = generateAdiContent(recordsToExport);
                fileExtension = 'adi';
            } else {
                content = generateCabrilloContent(recordsToExport, contest);
                fileExtension = 'log';
            }
            
            downloadFile(content, `${filename}.${fileExtension}`);
            showMessage(`æˆåŠŸå¯¼å‡º ${recordsToExport.length} æ¡è®°å½•`, 'success');
        }

        // ç”ŸæˆADIå†…å®¹
        function generateAdiContent(records) {
            let content = '';
            
            records.forEach(record => {
                content += '<ADIF_VER:5>3.1.0\n';
                content += `<CALL:${record.callsign.length}>${record.callsign}\n`;
                content += `<FREQ:${record.frequency.length}>${record.frequency}\n`;
                content += `<MODE:${record.mode.length}>${record.mode}\n`;
                content += `<QSO_DATE:8>${record.date.replace(/-/g, '')}\n`;
                content += `<TIME_ON:4>${record.time.replace(/:/g, '')}\n`;
                
                if (record.rstSent) {
                    content += `<RST_SENT:${record.rstSent.length}>${record.rstSent}\n`;
                }
                if (record.rstRcvd) {
                    content += `<RST_RCVD:${record.rstRcvd.length}>${record.rstRcvd}\n`;
                }
                if (record.name) {
                    content += `<NAME:${record.name.length}>${record.name}\n`;
                }
                if (record.qth) {
                    content += `<QTH:${record.qth.length}>${record.qth}\n`;
                }
                if (record.gridsquare) {
                    content += `<GRIDSQUARE:${record.gridsquare.length}>${record.gridsquare}\n`;
                }
                if (record.comment) {
                    content += `<COMMENT:${record.comment.length}>${record.comment}\n`;
                }
                
                content += '<EOR>\n';
            });
            
            return content;
        }

        // ç”ŸæˆCabrilloå†…å®¹
        function generateCabrilloContent(records, contest) {
            let content = 'START-OF-LOG: 3.0\n';
            
            // å¤´éƒ¨ä¿¡æ¯
            content += `CALLSIGN: ${AppState.settings.myCallsign || 'N0CALL'}\n`;
            if (AppState.settings.myGrid) {
                content += `LOCATION: ${AppState.settings.myGrid}\n`;
            }
            content += `CONTEST: ${contest || 'GENERAL'}\n`;
            content += 'CATEGORY-OPERATOR: SINGLE-OP\n';
            content += 'CATEGORY-ASSISTED: NON-ASSISTED\n';
            content += 'CATEGORY-BAND: ALL\n';
            content += 'CATEGORY-MODE: MIXED\n';
            content += 'CATEGORY-POWER: LOW\n';
            content += 'CATEGORY-STATION: FIXED\n';
            content += 'CATEGORY-TRANSMITTER: ONE\n';
            content += 'CLAIMED-SCORE: 0\n';
            content += 'OPERATORS: ' + (AppState.settings.myCallsign || 'N0CALL') + '\n';
            content += 'NAME: ' + (AppState.settings.myCallsign || 'N0CALL') + '\n';
            content += 'ADDRESS: Unknown\n';
            content += 'ADDRESS-CITY: Unknown\n';
            content += 'ADDRESS-STATE-PROVINCE: Unknown\n';
            content += 'ADDRESS-POSTALCODE: Unknown\n';
            content += 'ADDRESS-COUNTRY: Unknown\n';
            content += 'EMAIL: unknown@example.com\n';
            content += 'CREATED-BY: ELVES v1.10.2.20251019\n';
            content += '\n';
            
            // QSOè®°å½•
            records.forEach(record => {
                const date = record.date.replace(/-/g, '');
                const time = record.time.replace(/:/g, '').substr(0, 4);
                
                let qsoLine = `QSO: ${record.frequency} ${record.mode} ${date} ${time} `;
                qsoLine += `${AppState.settings.myCallsign || 'N0CALL'} ${record.rstSent || '59'} `;
                qsoLine += `${record.callsign} ${record.rstRcvd || '59'}`;
                
                // æ·»åŠ æ¯”èµ›ç‰¹å®šä¿¡æ¯
                if (contest === 'CQ WPX' && record.serial) {
                    qsoLine += ` ${record.serial}`;
                } else if (contest === 'CQWW' && record.cqzone) {
                    qsoLine += ` ${record.cqzone}`;
                } else if (contest === 'WAPC') {
                    qsoLine += ` ${record.qsosNumber || '0'} ${record.province || 'UNKNOWN'}`;
                }
                
                content += qsoLine + '\n';
            });
            
            content += 'END-OF-LOG:\n';
            return content;
        }

        // ä¸‹è½½æ–‡ä»¶
        function downloadFile(content, filename) {
            // ç¡®ä¿æ–‡ä»¶ååŒ…å«æ­£ç¡®çš„æ‰©å±•å
            if (!filename.includes('.')) {
                filename += '.txt'; // å¦‚æœæ²¡æœ‰æ‰©å±•åï¼Œé»˜è®¤æ·»åŠ .txt
            }
            
            // æ ¹æ®æ–‡ä»¶æ‰©å±•åè®¾ç½®æ­£ç¡®çš„ MIME ç±»å‹
            let mimeType = 'text/plain';
            if (filename.endsWith('.adi')) {
                mimeType = 'text/plain'; // ADI æ–‡ä»¶æœ¬è´¨æ˜¯æ–‡æœ¬æ–‡ä»¶
            } else if (filename.endsWith('.log')) {
                mimeType = 'text/plain'; // Cabrillo æ–‡ä»¶ä¹Ÿæ˜¯æ–‡æœ¬æ–‡ä»¶
            }
            
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.style.display = 'none';
            document.body.appendChild(a);
            
            // ä½¿ç”¨ setTimeout ç¡®ä¿ä¸‹è½½é“¾æ¥è¢«æ­£ç¡®åˆ›å»º
            setTimeout(() => {
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }

        // æ˜¾ç¤ºç¡®è®¤æ¨¡æ€æ¡†
        function showConfirmation(message, callback) {
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('confirmationModal').classList.add('active');
            
            const confirmBtn = document.getElementById('modalConfirm');
            confirmBtn.onclick = function() {
                closeModal();
                callback();
            };
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('confirmationModal').classList.remove('active');
        }

        // æ˜¾ç¤ºå…³äºä¿¡æ¯
        function showAbout() {
            document.getElementById('aboutModal').classList.add('active');
        }

        // å…³é—­å…³äºä¿¡æ¯
        function closeAbout() {
            document.getElementById('aboutModal').classList.remove('active');
        }

        // å…³é—­æ¨¡æ€æ¡†ï¼ˆç‚¹å‡»èƒŒæ™¯ï¼‰
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
